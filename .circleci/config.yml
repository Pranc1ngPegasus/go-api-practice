version: 2.1
executors:
  default:
    working_directory: ~/app
    docker:
      - image: cimg/go:1.15
        environment:
          ENV: test
          PORT: 3000
          DB_HOST: 127.0.0.1
          DB_DATABASE: practice_test
          DB_ROOT_PASSWORD: lqsym
          DB_USER: pranc1ngpegasus
          DB_PASSWORD: lqsym
          TZ: Asia/Tokyo
      - image: circleci/mysql:5.7
        environment:
          MYSQL_DATABASE: practice_test
          MYSQL_ROOT_PASSWORD: lqsym
          MYSQL_USER: pranc1ngpegasus
          MYSQL_PASSWORD: lqsym

workflows:
  version: 2.1
  ci-test:
    jobs:
      - test

jobs:
  test:
    executor:
      name: default
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - checkout

      - save_cache:
          key: source-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - ".git"

      - restore_cache:
          keys:
            - go-mod-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "go.sum" }}
            - go-mod-cache-v1-{{ arch }}-{{ .Branch }}
            - go-mod-cache-v1

      - run:
          name: go fmt
          command: diff -u <(echo -n) <(gofmt -d ./)

      - run:
          name: go vet
          command: make lint

      - run:
          name: go test
          command: make test

      - save_cache:
          key: go-mod-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg"

      - persist_to_workspace:
          root: .
          paths:
            - .
